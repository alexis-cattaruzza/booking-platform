<div class="min-h-screen bg-gray-50 py-8 px-4">
  <div class="max-w-4xl mx-auto">
    <!-- Page Title Header -->
    @if (business && step !== 'confirmation') {
      <div class="mb-6 text-center">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          Prendre rendez-vous chez {{ business.businessName }}
        </h1>
        <p class="text-gray-600">R√©servez votre cr√©neau en quelques clics</p>
      </div>
    }

    @if (error) {
      <div class="mb-6 rounded-md bg-red-50 p-4">
        <h3 class="text-sm font-medium text-red-800">{{ error }}</h3>
      </div>
    }

    @if (loading && !business) {
      <div class="flex justify-center items-center py-12">
        <div class="text-gray-600">Chargement...</div>
      </div>
    }

    @if (business && step !== 'confirmation') {
      <!-- Business Header -->
      <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900">{{ business.businessName }}</h2>
        @if (business.description) {
          <p class="mt-2 text-gray-600">{{ business.description }}</p>
        }
        <div class="mt-4 text-sm text-gray-500">
          @if (business.address) {
            <p>üìç {{ business.address }}, {{ business.postalCode }} {{ business.city }}</p>
          }
          <p>üìû {{ business.phone }} | ‚úâÔ∏è {{ business.email }}</p>
        </div>
      </div>

      <!-- Progress Steps -->
      <div class="bg-white shadow rounded-lg p-6 mb-6">
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div [class]="step === 'service' ? 'text-blue-600 font-medium' : 'text-gray-400'">
              1. Service
            </div>
          </div>
          <div class="flex-1 border-t-2 mx-4" [class]="step !== 'service' ? 'border-blue-600' : 'border-gray-300'"></div>
          <div class="flex-1">
            <div [class]="step === 'datetime' ? 'text-blue-600 font-medium' : step === 'customer' ? 'text-gray-900' : 'text-gray-400'">
              2. Date & Heure
            </div>
          </div>
          <div class="flex-1 border-t-2 mx-4" [class]="step === 'customer' ? 'border-blue-600' : 'border-gray-300'"></div>
          <div class="flex-1">
            <div [class]="step === 'customer' ? 'text-blue-600 font-medium' : 'text-gray-400'">
              3. Coordonn√©es
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Step 1: Service Selection -->
    @if (step === 'service') {
      <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Choisissez un service</h2>

        @if (services.length > 0) {
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            @for (service of services; track service.id) {
              <button
                (click)="selectService(service)"
                class="text-left p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors"
              >
                <div class="flex items-start">
                  <div class="w-1 h-16 rounded mr-3" [style.background-color]="service.color"></div>
                  <div class="flex-1">
                    <h3 class="font-medium text-gray-900">{{ service.name }}</h3>
                    @if (service.description) {
                      <p class="text-sm text-gray-600 mt-1">{{ service.description }}</p>
                    }
                    <div class="mt-2 flex items-center justify-between text-sm">
                      <span class="text-gray-500">{{ service.durationMinutes }} min</span>
                      <span class="font-medium text-blue-600">{{ formatPrice(service.price) }}</span>
                    </div>
                  </div>
                </div>
              </button>
            }
          </div>
        } @else if (!loading) {
          <div class="text-center py-12">
            <div class="text-gray-400 text-5xl mb-4">üìÖ</div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Aucun service disponible</h3>
            <p class="text-gray-600">Ce business n'a pas encore configur√© de services.</p>
            <p class="text-sm text-gray-500 mt-2">Veuillez contacter {{ business?.businessName }} directement.</p>
          </div>
        }
      </div>
    }

    <!-- Step 2: Date & Time Selection -->
    @if (step === 'datetime' && selectedService) {
      <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-900">Choisissez une date et heure</h2>
          <button (click)="back()" class="text-blue-600 hover:text-blue-800">‚Üê Retour</button>
        </div>

        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
          <p class="text-sm font-medium text-gray-900">Service s√©lectionn√©:</p>
          <p class="text-lg font-semibold text-blue-600">{{ selectedService.name }}</p>
          <p class="text-sm text-gray-600">{{ selectedService.durationMinutes }} min - {{ formatPrice(selectedService.price) }}</p>
        </div>

        <!-- Calendar -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <button (click)="previousMonth()" class="p-2 hover:bg-gray-100 rounded">‚Üê</button>
            <h3 class="text-lg font-medium capitalize">{{ getMonthYear() }}</h3>
            <button (click)="nextMonth()" class="p-2 hover:bg-gray-100 rounded">‚Üí</button>
          </div>

          <div class="grid grid-cols-7 gap-2">
            <div class="text-center text-sm font-medium text-gray-500 py-2">Lun</div>
            <div class="text-center text-sm font-medium text-gray-500 py-2">Mar</div>
            <div class="text-center text-sm font-medium text-gray-500 py-2">Mer</div>
            <div class="text-center text-sm font-medium text-gray-500 py-2">Jeu</div>
            <div class="text-center text-sm font-medium text-gray-500 py-2">Ven</div>
            <div class="text-center text-sm font-medium text-gray-500 py-2">Sam</div>
            <div class="text-center text-sm font-medium text-gray-500 py-2">Dim</div>

            @for (day of calendarDays; track $index) {
              @if (day === null) {
                <div class="aspect-square"></div>
              } @else {
                <button
                  (click)="selectDate(day)"
                  [disabled]="!isDateSelectable(day)"
                  [class]="isDateSelected(day) ? 'bg-blue-600 text-white' : isDateSelectable(day) ? 'bg-white hover:bg-blue-50' : 'bg-gray-100 text-gray-400 cursor-not-allowed'"
                  class="aspect-square flex items-center justify-center rounded-lg border transition-colors"
                >
                  {{ day.getDate() }}
                </button>
              }
            }
          </div>
        </div>

        <!-- Time Slots -->
        @if (selectedDate) {
          <div>
            <h3 class="text-lg font-medium text-gray-900 mb-3">
              Cr√©neaux disponibles pour le {{ formatDate(selectedDate) }}
            </h3>

            @if (loadingAvailability) {
              <div class="text-center py-4 text-gray-600">Chargement des cr√©neaux...</div>
            }

            @if (!loadingAvailability && availableSlots.length === 0) {
              <div class="text-center py-8 text-gray-500">
                Aucun cr√©neau disponible pour cette date
              </div>
            }

            @if (!loadingAvailability && availableSlots.length > 0) {
              <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                @for (slot of availableSlots; track $index) {
                  <button
                    (click)="selectTimeSlot(slot)"
                    class="px-4 py-2 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm font-medium"
                  >
                    {{ formatTime(slot.startTime) }}
                  </button>
                }
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Step 3: Customer Form -->
    @if (step === 'customer' && selectedService && selectedDate && selectedTimeSlot) {
      <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-900">Vos coordonn√©es</h2>
          <button (click)="back()" class="text-blue-600 hover:text-blue-800">‚Üê Retour</button>
        </div>

        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
          <p class="text-sm font-medium text-gray-900">R√©capitulatif:</p>
          <p class="text-lg font-semibold text-blue-600">{{ selectedService.name }}</p>
          <p class="text-sm text-gray-600">
            {{ formatDate(selectedDate) }} √† {{ formatTime(selectedTimeSlot.startTime) }}
          </p>
          <p class="text-sm text-gray-600">
            Dur√©e: {{ selectedService.durationMinutes }} min - {{ formatPrice(selectedService.price) }}
          </p>
        </div>

        <form [formGroup]="customerForm" (ngSubmit)="onSubmit()" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">
                Pr√©nom <span class="text-red-500">*</span>
              </label>
              <input
                id="firstName"
                type="text"
                formControlName="firstName"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div>
              <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">
                Nom <span class="text-red-500">*</span>
              </label>
              <input
                id="lastName"
                type="text"
                formControlName="lastName"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>

          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
              Email <span class="text-red-500">*</span>
            </label>
            <input
              id="email"
              type="email"
              formControlName="email"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          <div>
            <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-1">
              T√©l√©phone <span class="text-red-500">*</span>
            </label>
            <div class="flex gap-2">
              <select
                formControlName="phoneCountry"
                class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                @for (country of countries; track country.code) {
                  <option [value]="country.dialCode">{{ country.dialCode }} {{ country.name }}</option>
                }
              </select>
              <input
                id="phoneNumber"
                type="tel"
                formControlName="phoneNumber"
                placeholder="612345678"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <p class="mt-1 text-xs text-gray-500">Entrez uniquement les chiffres (6-15 chiffres)</p>
          </div>

          <div>
            <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">
              Notes (optionnel)
            </label>
            <textarea
              id="notes"
              formControlName="notes"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            ></textarea>
          </div>

          <div class="pt-4">
            <button
              type="submit"
              [disabled]="customerForm.invalid || loading"
              class="w-full py-3 px-4 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
            >
              {{ loading ? 'R√©servation en cours...' : 'Confirmer la r√©servation' }}
            </button>
          </div>
        </form>
      </div>
    }

    <!-- Step 4: Confirmation -->
    @if (step === 'confirmation') {
      <div class="bg-white shadow rounded-lg p-8 text-center">
        <div class="mb-6">
          <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
        </div>

        <h2 class="text-2xl font-bold text-gray-900 mb-2">R√©servation confirm√©e !</h2>
        <p class="text-gray-600 mb-6">
          Vous allez recevoir un email de confirmation avec tous les d√©tails de votre rendez-vous.
        </p>

        <div class="bg-gray-50 rounded-lg p-6 mb-6 text-left">
          <h3 class="font-semibold text-gray-900 mb-3">D√©tails de votre rendez-vous:</h3>
          @if (selectedService && selectedDate && selectedTimeSlot) {
            <div class="space-y-2 text-sm text-gray-600">
              <p><span class="font-medium">Service:</span> {{ selectedService.name }}</p>
              <p><span class="font-medium">Date:</span> {{ formatDate(selectedDate) }}</p>
              <p><span class="font-medium">Heure:</span> {{ formatTime(selectedTimeSlot.startTime) }}</p>
              <p><span class="font-medium">Dur√©e:</span> {{ selectedService.durationMinutes }} minutes</p>
              <p><span class="font-medium">Prix:</span> {{ formatPrice(selectedService.price) }}</p>
            </div>
          }
        </div>

        @if (business) {
          <div class="text-sm text-gray-600 mb-6">
            <p class="font-medium text-gray-900 mb-2">{{ business.businessName }}</p>
            @if (business.address) {
              <p>{{ business.address }}</p>
              <p>{{ business.postalCode }} {{ business.city }}</p>
            }
            <p class="mt-2">{{ business.phone }}</p>
          </div>
        }
      </div>
    }
  </div>
</div>
